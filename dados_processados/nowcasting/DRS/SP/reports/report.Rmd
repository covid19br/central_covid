---
title: "Análise de dados COVID-19 por DRS do Estado de São Paulo"
date: "`r Sys.Date()`"
author: "Observatório COVID-19 BR"
output:
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    thumbnails: false
    lightbox: false
    toc_depth: 4
---

```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)
library(rmdformats)
library(stringr)
## Global options
options(max.print = "75")
opts_chunk$set(echo = FALSE,
	           cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
opts_knit$set(width = 75)
```

```{r echo = FALSE, results = "asis"}
#output.dir <- "../outputs/DRS/SP/"
output.dir <- "../"
regioes <- 1:17
names(regioes) <- c("Grande_Sao_Paulo",
                    "Aracatuba",
                    "Araraquara",
                    "Baixada_Santista",
                    "Barretos",
                    "Bauru",
                    "Campinas",
                    "Franca",
                    "Marilia",
                    "Piracicaba",
                    "Presidente_Prudente",
                    "Registro",
                    "Ribeirao_Preto",
                    "Sao_Joao_da_Boa_Vista",
                    "Sao_Jose_do_Rio_Preto",
                    "Sorocaba",
                    "Taubate")
DRS.to.include <- 1:17
for (i in DRS.to.include) {
    regiao.nome = names(regioes)[i]
    regiao.id = as.roman(i)

    # pula os que não têm gráficos
    if (! file.exists(paste0(output.dir,regiao.nome,'/plots/plot_nowcast_srag.svg')))
        continue

    cat(str_interp("# DRS ${regiao.id} - ${regiao.nome}\n\n"))

    for (tipo in c("COVID-19", "SRAG")) {
        if (tipo == "COVID-19") tipol <- "covid"
        if (tipo == "SRAG") tipol <- "srag"

        cat(str_interp("## ${tipo} \n\n"))

        for (casos in c("Casos", "Óbitos")) {
            if (casos == "Casos") ob <- ""
            if (casos == "Óbitos") ob <- "ob_"

            if (file.exists(paste0(output.dir,regiao.nome,'/plots/plot_nowcast_',ob,tipol,'.svg')))
                cat(str_interp("

### ${casos} ${tipo} Diários

![${casos} ${tipo} diários](${output.dir}${regiao.nome}/plots/plot_nowcast_${ob}${tipol}.svg)

 Os pontos em vermelho são os casos notificados há mais de 40 dias, para os quais assumimos que não é preciso estimar futuras notificações.
Os pontos em azul são os casos diários estimados através da correção do atraso entre a data dos primeiros sintomas e a notificação.
A linha preta é a tendência estimada, com média móvel para um período de 10 dias. 

"))
            if (file.exists(paste0(output.dir,regiao.nome,'/plots/plot_nowcast_cum_',ob,tipol,'.svg')))
                cat(str_interp("

### ${casos} ${tipo} acumulados e projeção

![${casos} ${tipo} diários](${output.dir}${regiao.nome}/plots/plot_nowcast_cum_${ob}${tipol}.svg)

A linha azul contínua indica o número de casos observados acumulados até a última data. A linha vermelha contínua indicam o número de casos estimados acumulados, corrigindo o tempo entre os primeiros sintomas e a notificação. Por se tratar de números muito discrepantes ao longo do tempo, o gráfico de casos acumulados está em escala logarítmica.
Os pontos tracejados da linha vermelha são as projeções para os últimos 2 dias e para os próximos 5 dias, se a taxa de crescimento dos valores corrigidos continuar a mesma dos últimos 5 dias. A faixa cinza mostra o intervalo de 95% de confiança dessa projeção. 

"))

            #if (file.exists(paste0(output.dir,regiao.nome,'/plots/plot_tempo_dupl_',ob,tipol,'.svg')))
            if(FALSE)  # no TD for now
                cat(str_interp("

### ${casos} ${tipo}: Tempo de duplicação

![Tempo de duplicação de ${casos} ${tipo}](${output.dir}${regiao.nome}/plots/plot_tempo_dupl_${ob}${tipol}.svg)

O tempo de duplicação indica quanto tempo leva para dobrar o número de casos graves (hospitalizados) no município de São Paulo. Quanto menor esse número, mais rápido a doença está se espalhando.
Esse número depende muito das medidas de contenção da doença, como o distanciamento social e outras medidas não farmacológicas.
A linha verde no gráfico mostra o tempo de duplicação estimado, calculado sobre intervalos de 5 dias.
A faixa cinza é o intervalo de confiança desses tempos de duplicação. O intervalo largo mostra que a incerteza é grande, mas mesmo assim vemos que tempos de duplicação variam à medida que o tempo passa.


"))

    }
    if (file.exists(paste0(output.dir,regiao.nome,'/plots/plot_estimate_R0_',tipol,'.svg')))
        cat(str_interp("
### Número de reprodução efetivo (calculado com casos ${tipo})

![Tempo de duplicação de ${casos} ${tipo}](${output.dir}${regiao.nome}/plots/plot_estimate_R0_${tipol}.svg)

O Número Reprodutivo efetivo (*Re*) é a média de pessoas contaminadas por um infectado. Valores maiores que 1 indicam que o número de novos casos está aumentando. Marcamos este limite com uma linha vermelha. Valores de *Re* próximo de um indicam que a cada dia temos um número constante de casos. E apenas valores de Re abaixo de um por muitos dias indica seguramente tendência de redução no número de casos.

Estimamos o Re da epidemia de COVID-19 no Brasil diariamente no município de São Paulo baseando-se nos dados estimados de casos graves.
A linha roxa no gráfico mostra a estimativa de
a intervalos de 7 dias (as datas indicam o fim de cada um desses intervalos). A faixa cinza é o intervalo de confiança dessas estimativas. Esse intervalo tem 95% de chance de incluir o valor real de Re. 


"))
  }
}

```

# Tabela de R efetivo

```{r Rtable, echo=FALSE, message=FALSE, results="asis", cache=FALSE}
library(zoo)
library(kableExtra)

data <- list.files(paste0(output.dir, "Grande_Sao_Paulo", "/tabelas_nowcasting_para_grafico/"), pattern="r_efetivo_covid_.*.csv") %>%
    # regex para catar data
    stringr::str_extract("(19|20)\\d\\d[_ /.](0[1-9]|1[012])[_ /.](0[1-9]|[12][0-9]|3[01])") %>%
    as.Date(format = "%Y_%m_%d") %>%
    max(na.rm = TRUE) %>%
    format("%Y_%m_%d")

cat(paste("Baseado em banco de dados de", data))

zoos <- list()
for (covid in c("covid", "srag")){
    for (drs in list.files(output.dir)){
        file <- paste0(output.dir, drs, "/tabelas_nowcasting_para_grafico/r_efetivo_", covid, "_", data, ".csv")
        d <- read.csv(file)
        z <- zoo(d$Median.R, as.Date(d$data))
        zoos[[paste(drs, covid, sep=".")]] <- z
    }
}

R.median <- as.data.frame(do.call(merge, zoos))
R.median <- R.median[order(rownames(R.median), decreasing=TRUE),]

kable(R.median, row.names=TRUE, digits=2) %>%
  kable_styling(fixed_thead = T) %>%
  scroll_box(height = "700px")
```


# Detalhes técnicos

## Nowcasting

 Para calcular uma estimativa do número de casos a cada dia, utilizamos os dados de notificação de hospitalizações por SRAG (Síndrome Respiratória Aguda Grave) da base SIVEP-Gripe. É nesta base que são notificados os casos graves suspeitos de COVID-19, que são os casos SRAG hospitalizados. Cada um desses casos deve ser investigado para confirmação ou não como caso de COVID-19.

A este conjunto de dados é aplicada uma técnica estatística Bayesiana de nowcasting, um método que corrige os atrasos do sistema de notificação vigente, isto é, adianta-se às notificações oficiais futuras pelo tempo entre a ocorrência dos primeiros sintomas no paciente e a notificação, quando há o registro dos seus dados no sistema de vigilância.

Esse tempo abrange várias etapas: desde procurar um hospital, coletar o exame, o exame ser realizado e o resultado do teste positivo para Covid-19 estar disponível para ser incluído no banco de dados. O tempo acumulado entre essas etapas do processo causa atrasos de vários dias entre o número de casos confirmados no SIVEP-Gripe e os casos ainda não disponíveis no sistema, que são compensados somando aos casos já confirmados uma estimativa de casos que devem ser confirmados no futuro. O método que usamos foi proposto por McGough et.al. (2019) e implementado usando o pacote NobBS do R (McGough et.al. 2020).

Essa não é uma estimativa do número total de pessoas infectadas pelo novo coronavírus, apenas de casos graves hospitalizados e notificados no sistema de vigilância. Isso porque os casos notificados oficialmente diferem do número de casos reais na mesma data pois são distorcidos tanto por atrasos de notificação (corrigidos pelo nowcasting) quanto por subnotificação (que não pode ser corrigida por nowcasting).

## Tempo de duplicação

No início das epidemias o número de infectados cresce exponencialmente, o que implica que o tempo para que o número de casos duplique é constante e vale *ln(2)/r*, onde *r* é a taxa de crescimento de número de casos. Um crescimento exponencial a taxa constante também implica em uma relação linear entre o logaritmo do número de casos e o tempo. Essa expectativa em geral vale para pequenos intervalos de tempo, na fase inicial de epidemias.

## Projeção de curto prazo

Com o modelo linear ajustado anteriormente (entre o logaritmo do número de casos e o tempo) estimamos o número de casos para os próximos dias, e os intervalos de confiança dos valores previstos.


## Estimativa do Número de Reprodução - R efetivo

Em epidemiologia, uma das medidas mais importantes é o número reprodutivo basal ou razão de reprodução básica (*R0*). Essa medida indica o número de casos secundários que um indivíduo infeccioso pode gerar em uma população totalmente suscetível. Apesar de ser muito útil para avaliar o potencial de propagação de doenças infecciosas em diferentes contextos, *R0* é uma medida teórica. Com a propagação de doenças infecciosas com altas taxas de transmissibilidade, muitas pessoas se infectam e, em diversos casos, indivíduos que já foram infectados podem tornar-se resistentes, não pertencendo mais ao grupo de suscetíveis. Neste momento, a premissa de uma população totalmente suscetível passa a não ser mais uma boa aproximação da realidade e uma nova medida epidemiológica faz-se necessária. Essa medida é o número reprodutivo efetivo ou razão de reprodução efetiva (*Re*). Esse número indica o número de casos secundários produzidos em uma população na qual nem todos são suscetíveis.

Para analisar a dinâmica instantânea de uma doença infecciosa que tem potencial de infectar grande parte da população, o valor de *Re* calculado ao longo do tempo pode informar o quão crítico é o atual estágio de uma epidemia. Podemos calcular o *Re* utilizando séries temporais de dados de incidência (novos casos a cada dia, semana, etc.) e a distribuição de intervalos seriais, definidos como o intervalo de tempo entre o início dos sintomas em um caso primário e o início dos sintomas em um caso secundário. O intervalo serial é uma medida difícil de ser obtida, principalmente para doenças infecciosas com pouco estudo epidemiológico. Para contornar esse problema, pode-se estimar o valor de *Re* considerando incertezas na medida do intervalo serial.

Usamos uma janela de 7 dias de incidência de COVID-19 (ou de SRAG) para estimar diariamente o valor de *Re*, utilizando a metodologia de Cori et al. (2019), implementada no pacote EpiEstim do software R. Para a medida de intervalo serial, utilizamos uma distribuição log-normal truncada com média 4.8 (IC 95%, 3.8 - 6.1) e desvio padrão 2.3 (IC 95%, 1.6 - 3.5) em conformidade com o estudo de Nishiura et al. (2020).

## Referências

1. Ane Cori (2019). EpiEstim: Estimate Time Varying Reproduction Numbers from Epidemic Curves. R package version 2.2-1. https://CRAN.R-project.org/package=EpiEstim
2. Nishiura H, Linton NM, Akhmetzhanov AR, Serial interval of novelcoronavirus (COVID-19) infections. International Journal of Infectious Diseases, 2020. doi: https://doi.org/10.1016/j.ijid.2020.02.060
3. McGough, Sarah , Michael A. Johansson, Marc Lipsitch, Nicolas A. Menzies (2019). Nowcasting by Bayesian Smoothing: A flexible, generalizable model for real-time epidemic tracking. bioRxiv 663823; doi: https://doi.org/10.1101/663823
4. McGough, Sarah, Nicolas Menzies, Marc Lipsitch and Michael Johansson (2020). NobBS: Nowcasting by Bayesian Smoothing. R package version 0.1.0. https://CRAN.R-project.org/package=NobB

# Observatório COVID-19 BR

O Observatório Covid-19 BR é uma iniciativa independente, fruto da
colaboração entre pesquisadores com o desejo de contribuir para a
disseminação de informação de qualidade baseada em dados atualizados e
análises cientificamente embasadas. 

Criamos um sítio com códigos de fonte aberta que nos permite
acompanhar o estado atual da epidemia de Covid-19 no Brasil, incluindo
análises estatísticas e previsões. Modelos estatísticos e matemáticos
para previsões da epidemia estão em preparação

**Site:** https://covid19br.github.io

**Contato:** obscovid19br@gmail.com

